# TradeWise - 智慧投资追踪系统

## 项目概述
这是一个全栈个人投资追踪系统，帮助用户管理和分析股票、基金等投资资产，追踪投资收益并可视化展示投资组合表现。支持从券商交割单自动导入交易记录，智能识别多种文件格式。

## 技术栈

### 后端
- **框架**: Python 3 + FastAPI
- **数据库**: SQLite + SQLAlchemy ORM
- **数据源**: akshare (中国股票数据)
- **API端口**: 8001

### 前端
- **框架**: React 18 + Vite
- **样式**: TailwindCSS
- **图表库**: 
  - Recharts (收益曲线、饼图)
  - Lightweight Charts (K线图)
- **HTTP客户端**: Axios
- **开发端口**: 5173

## 核心功能

### 1. 数据同步
- 支持A股股票代码同步（如600519茅台、000333美的）
- 获取历史K线数据（开高低收、复权价格、成交量）
- 自动获取前复权、后复权数据
- **一键同步**: 批量同步所有持仓历史标的的K线数据

### 2. 交割单导入（增强版）
- **多格式支持**: .xls, .xlsx, .csv 文件
- **智能识别**: 自动识别券商交割单格式
  - 支持标准格式：`交割日期, 证券代码, 证券名称, 业务类型...`
  - 支持带引号格式：`="交割日期", ="证券代码"...`（从Excel导出的特殊格式）
- **自动过滤**: 只保留"证券买入"和"证券卖出"记录，自动过滤回购、分红、配股等非交易记录
- **费用计算**: 自动计算佣金、印花税、过户费
- **批量上传**: 支持同时上传多个交割单文件
- **自动去重**: 导入时自动跳过重复记录
- **代码补零**: 自动将证券代码补齐6位（如 792 → 000792）

### 3. 交易记录管理
- 交易记录列表展示（日期、代码、类型、数量、价格、费用）
- 彩色标识：买入（红色）、卖出（绿色）
- 实时导入反馈：显示新增、重复、过滤记录数
- 自动创建缺失的资产信息

### 4. 投资组合分析
- 总资产收益曲线（按时间序列计算）
- 持仓占比饼图
- 实时持仓详情表（持数量、当前价、市值、占比）

### 5. 个股分析
- **K线图展示**: 支持前复权数据
- **买卖点标记**: 红色箭头买入、绿色箭头卖出，自动调整视图范围显示所有交易点
- **图表模式**: 支持蜡烛图、折线图、混合模式
- **智能视图**: 自动调整时间范围，确保所有买卖点可见
- 支持搜索和筛选股票
- 支持"所有标的"和"持仓历史"两种视图模式

## 数据库设计

### Asset 表
- id: 主键
- symbol: 股票代码（唯一）
- name: 股票名称
- asset_type: 资产类型（stock/fund/future）

### Transaction 表
- id: 主键
- asset_id: 关联资产ID
- date: 交易日期
- type: 交易类型（buy/sell）
- quantity: 数量
- price: 价格
- fees: 手续费（佣金+印花税+过户费）

### PriceHistory 表
- id: 主键
- asset_id: 关联资产ID
- date: 日期
- open, high, low, close: 原始价格
- adj_open, adj_high, adj_low, adj_close: 后复权价格
- qfq_open, qfq_high, qfq_low, qfq_close: 前复权价格
- volume: 成交量

## API端点

| 端点 | 方法 | 说明 |
|------|------|------|
| /assets | GET | 获取所有资产列表 |
| /assets/sync/{symbol} | POST | 同步指定股票数据 |
| /assets/with-transactions | GET | 获取有交易记录的资产列表 |
| /transactions | GET | 获取所有交易记录 |
| /transactions/import | POST | 导入交割单文件（支持多格式） |
| /portfolio/summary | GET | 获取持仓汇总 |
| /portfolio/equity-curve | GET | 获取收益曲线 |
| /charts/{symbol} | GET | 获取图表数据（含K线和买卖点） |
| /debug/transactions | GET | 调试：查看交易记录统计 |

## 项目结构

```
.
├── backend/              # 后端API服务
│   ├── main.py           # FastAPI主入口和路由
│   ├── models.py         # 数据库模型定义
│   ├── sync.py           # 数据同步逻辑（akshare）
│   ├── portfolio.py      # 投资组合计算逻辑
│   └── investments.db    # SQLite数据库
├── frontend/             # 前端React应用
│   ├── src/
│   │   └── App.jsx       # 主应用组件
│   ├── package.json      # 前端依赖配置
│   ├── vite.config.js    # Vite配置
│   └── tailwind.config.js # TailwindCSS配置
├── AI_PROMPT.md          # AI复现提示词
├── AGENTS.md             # 项目启动指南
└── README.md             # 项目说明文档
```

## 快速启动

### 1. 安装后端依赖
```bash
cd backend
python3 -m pip install akshare fastapi uvicorn sqlalchemy pandas
```

### 2. 启动后端服务
```bash
cd backend
python3 main.py
```
后端API将运行在 `http://localhost:8001`

### 3. 安装前端依赖
```bash
cd frontend
npm install
```

### 4. 启动前端服务
```bash
cd frontend
npm run dev
```
前端应用将运行在 `http://localhost:5173`

## 使用流程

### 1. 导入交割单
- 进入"交易记录"页面
- 点击"选择文件（支持多选）"按钮
- 支持同时选择多个 .xls/.xlsx/.csv 文件
- 系统自动识别格式并导入，显示导入统计

### 2. 查看投资组合
- Dashboard页面显示：
  - 收益曲线（总资产随时间变化）
  - 持仓占比饼图
  - 实时持仓详情表

### 3. 个股分析
- 进入"个股分析"页面
- 选择"持仓历史"视图查看有交易记录的股票
- 点击股票查看K线图和买卖点
- K线图自动调整范围显示所有交易点

### 4. 同步K线数据
- **单个同步**: 在顶部栏选择股票代码，点击"同步数据"
- **批量同步**: 在个股分析页面点击"一键同步持仓标的"，批量同步所有持仓股票的K线数据

## 支持的交割单格式

### 1. 券商标准格式（从券商系统导出）
```
交割日期    证券代码    证券名称    业务类型    成交价格    成交数量    成交金额    佣金    印花税    过户费
20260113    000792      盐湖股份    证券卖出    33.85       100         3385        0.29    1.69      0
```

### 2. 带引号格式（Excel特殊导出格式）
```
="交割日期"    ="证券代码"    ="证券名称"    ="业务类型"    ="成交价格"    ="成交数量"
="20260113"   ="000792"      ="盐湖股份"    ="证券卖出"    ="33.85"        ="100"
```

### 3. 标准CSV格式
```csv
date,symbol,type,quantity,price,fees
2024-01-02,600519,buy,100,1650.0,10.5
2024-01-15,600519,sell,50,1600.0,8.5
```

## 技术特性

- **智能格式识别**: 自动识别多种交割单格式，支持带引号的Excel导出格式
- **自动过滤**: 智能过滤非交易记录（回购、分红、配股等），只保留证券买入/卖出
- **批量处理**: 支持同时上传和导入多个交割单文件
- **自动去重**: 导入交易记录时自动跳过重复数据
- **前复权数据**: 使用前复权价格进行K线展示和收益计算
- **买卖点标记**: K线图上自动标记买入/卖出点，智能调整视图范围
- **响应式设计**: 前端适配不同屏幕尺寸
- **实时更新**: 数据变化后自动刷新页面
- **错误处理**: 完善的异常捕获和用户提示
- **一键同步**: 批量同步所有持仓标的K线数据

## 扩展建议

- [ ] 添加用户认证和权限管理
- [ ] 支持多种数据源（如雅虎财经、Alpha Vantage）
- [ ] 添加更多技术指标（MACD、RSI、KDJ等）
- [ ] 实现数据导出功能（导出交易记录、收益报表）
- [ ] 添加邮件/短信预警功能（价格提醒）
- [ ] 支持国际市场（美股、港股等）
- [ ] 添加交易盈亏分析报表
- [ ] 支持多账户管理

## 最近更新

### 2025-02-08
- ✨ 新增一键同步所有持仓标的K线数据功能
- ✨ 支持批量上传多个交割单文件
- ✨ K线图自动调整视图范围显示所有买卖点
- ✨ 交易记录列表实时展示
- 🔧 修复带引号Excel格式（="..."）的解析问题
- 🔧 增强交割单导入，支持自动过滤非交易记录
